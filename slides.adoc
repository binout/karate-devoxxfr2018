= Ceinture noire `Karate` en tests d’API REST
:icons: font
:asset-uri-scheme: https
:source-highlighter: highlightjs
:deckjs_theme: swiss
:deckjs_transition: fade
:navigation: true
:goto: true
:status: true

image::images/devoxx.png[float="right"]

== Nico et Benoit

TODO

== Problématique

On doit faire des tests d'intégration sur une API REST.
On est plutôt des développeurs Java.
On a l'habitude de faire tests avec un client HTTP 

== JaxRs Client

[source, java]
----
@Test
public void should_finish_order_if_order_can_be_updated() throws IOException {
    // Create new Order
    final String orderId = IntegrationTestCase.newProductOrderId();

    // Finish Order
    final Response response = IntegrationTestCase.newClient().path("/product-orders/" + orderId + "/ending")
            .request()
            .post(Entity.json("{}"));
    assertThat(response.getStatusInfo()).isEqualTo(Status.OK);
}
----

* besoin de commentaires, nommer les méthodes, nommer les tests, utiliser des factories
* verbeux
* maintenance et écriture pénible (et uniquement par les développeurs)

== Rest Assured

[source, java]
----
@Test
public void lotto_resource_returns_200_with_expected_id_and_winners() {

  when().
    get("/lotto/{id}", 5).
  then().
    statusCode(200).
      body("lotto.lottoId", equalTo(5),
      "lotto.winners.winnerId", containsOnly(23, 54));
}
----

* plus élégante avec un DSL java
* mais reste du code, et verbeux ...
* voir pour faire un diff avec que la partie utile ?

[canvas-image=images/karate-large.png]
== Karate Large

== Karate

[quote]
Web-Services Testing Made Simple.

icon:github[] https://github.com/intuit/karate (+500 icon:star[])

icon:twitter[] @KarateDSL

* Février 2017 : 1ère release (`0.1.2`)
* Mars 2018 : `0.7.0`

== Hello Cats

image::https://github.com/intuit/karate/raw/master/karate-demo/src/test/resources/karate-hello-world.jpg[]

== Demo

Live coding

[source]
----
java -jar karate.jar -m cfp-speaker.feature
----

== Lexique

* Définition
** Feature
** Scenario
** Background

== Tests avec Karate

* DSL (basé sur Cucumber) pour écrire des tests d'API HTTP

icon:warning[] ce n'est pas du BDD !

* Simple : Facile à écrire et à maintenir
* Pas de _glue_  à coder
* Rapide à exécuter
* JSON _first class citizen_
* Parallélisme optionnel _gratuit_

== Intégration 

* Intégration Eclipse/Intellij
** support Cucumber plugin
* Intégration Maven/Gradle
* Intégration JUnit4/TestNG
** Runner
* Structure de répertoires pour organiser les features
** karate-config.js
** mutualisation feature 

== Démo dans l'IDE

Enchainer un scénario complet (film/acteur/karate)

* POST (json)
* Récupérer dans Location l'ID (notion de variable partagée aux scénarios)
* GET
* PUT (maj)

* Faire un GET sur la liste d'entités
* Utiliser le `contains` pour asserter l'existence
* Montrer les matchers, #UUID, #notnull, ..

* BONUS : mode UI

== Des chiffres

* Nombre de Tests
* Nombre de Features
** Features de setup
* Temps d'execution

== Pour aller plus loin

* Utilisation de fonctions javascript/java
* Authent (Basic Auth)
* Test mock : consumer driving contract
** mode mock `java -jar karate-netty-all.jar -m my-mock.feature -p 8080`
